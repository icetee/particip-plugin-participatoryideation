<#include "manageideation_idee_tabs.html" />
<@tabs tab="idee" />

<@rowBoxHeader i18nTitleKey="participatoryideation.create_idee.pageTitle">

	<#-- *********************************************************************************** -->
	<#-- * FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM * -->
	<#-- * FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM FORM * -->
	<#-- *********************************************************************************** -->

	<form class="form-horizontal" method="post" name="create_idee" action="jsp/admin/plugins/participatoryideation/ManageIdees.jsp">
		<@messages errors=errors />
		<input type="hidden" id="id" name="id"/>

		<@fieldInputText i18nLabelKey="participatoryideation.create_idee.labelTitre"       mandatory=true inputName="titre"       value="${idee.titre!}"       i18nHelpBlockKey='ideation.create_idee.labelTitre.help'       />

		<@fieldTextArea  i18nLabelKey="participatoryideation.create_idee.labelDescription" mandatory=true inputName="description" value="${idee.description!}" i18nHelpBlockKey='ideation.create_idee.labelDescription.help' />

		<@fieldInputText i18nLabelKey="participatoryideation.create_idee.labelCout"        inputName="cout"        value="${idee.cout!}"       i18nHelpBlockKey='ideation.create_idee.labelCout.help'        />

		<@fieldInputCombo i18nLabelKey="participatoryideation.create_idee.labelLocalisationType" inputName="localisationType" items=type_localisation_list value="${(idee.localisationType)!}" i18nHelpBlockKey="participatoryideation.create_idee.labelLocalisationType.help" />

		<@fieldInputCombo i18nLabelKey="participatoryideation.create_idee.labelLocalisationArdt" inputName="localisationArdt" items=arrondissements_list value="${(idee.localisationArdt)!}" i18nHelpBlockKey="participatoryideation.create_idee.labelLocalisationArdt.help" />

		<div class="form-group">
			<label class="col-xs-12 col-sm-3 col-md-3" for="thematique">#i18n{ideation.create_idee.labelCodeTheme} : </label>
			<div class="col-xs-12 col-sm-9 col-md-9">
				<select id="thematique" name="codeTheme" class="form-control">
					<#list campagnetheme_list as campagnetheme >
						<option value="${campagnetheme.code}" <#if idee.codeTheme?? && campagnetheme.code==idee.codeTheme> selected="selected"</#if>>${campagnetheme.codeCampagne} - ${campagnetheme.title!}</option>
					</#list>
				</select>
				<p class="help-block">#i18n{ideation.create_idee.labelCodeTheme.help}</p>
			</div>
		</div>

		<div class="form-group">
			<label class="col-xs-12 col-sm-3 col-md-3" for="handicap">#i18n{ideation.create_idee.labelHandicap} : </label>
			<div class="col-xs-12 col-sm-9 col-md-9">
				<select id="handicap" name="handicap" class="form-control">
					<#list handicap_list as handicap >
						<option value="${handicap.code}" <#if idee.handicap?? && handicap.code==idee.handicap> selected="selected"</#if>>${handicap.name}</option>
					</#list>
				</select>
				<p class="help-block">#i18n{ideation.create_idee.labelHandicap.help}</p>
			</div>
		</div>

        <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-3" for="adress">#i18n{ideation.create_idee.labelGeoloc} : </label>
            <div class="col-xs-12 col-sm-9 col-md-9">
                <div class="input-group">
                    <input type="text" class="form-control" name="adress" id="adress" value="${idee.adress!''}">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button" title="effacer" id="button_delete_address"><i class="fa fa-times"></i></button>
                    </span>
                </div>
                <p class="help-block">#i18n{ideation.create_idee.labelGeoloc.help}</p>
            </div>
        </div>
        <input id="geojson" type="hidden" name="geo_json" value="${(idee.geoJson?html)!''}">
        <input id="geojson_state" type="hidden">


		<@actionButtons button1Name="action_createIdee" button2Name="view_manageIdees"/>

	</form>
</@rowBoxHeader>



<#-- *********************************************************************************** -->
<#-- * JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS J * -->
<#-- * JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS JS J * -->
<#-- *********************************************************************************** -->

<script type="text/javascript" src="js/proj4js-combined.js"></script>
<script type="text/javascript" src="jsp/admin/plugins/address/modules/autocomplete/SetupSuggestPOI.js.jsp"></script>
<script type="text/javascript" src="js/plugins/address/modules/autocomplete/jQuery.suggestPOI.js"></script>

<script type='text/javascript'>
$(window).load(function() {
    var sourceSRID = new Proj4js.Proj('EPSG:27561');
    var destSRID = new Proj4js.Proj('EPSG:4326');
    var jAdresse = $('#adress');
    jAdresse.suggestPOI();
    jAdresse.bind($.suggestPOI.EVT_SELECT, function(event) {

        var poi = event.poi;
        if (poi) {
            var address = poi.libelleTypo;
            var lambert_x = poi.x;
            var lambert_y = poi.y;
            p = new Proj4js.Point(lambert_x, lambert_y);
            Proj4js.transform(sourceSRID, destSRID, p);

            var obj = {
                "type" : "Feature",
                "properties" : {
                    "address" : address
                },
                "geometry" : {
                    "type" : "Point",
                    "coordinates" : [ p.x, p.y ]
                }
            };
            $('#geojson').val(JSON.stringify(obj));
            $('#geojson_state').val(JSON.stringify(obj));
        }
    });

    $("#button_delete_address").on('click', function() {
        $('#adress').val("");
        //Don't put the empty string to disambiguate with the user
        //clearing the field, and then pressing the browser back button
        $('#geojson_state').val("false");
        $('#geojson').val("");
    });

    //Try to restore from back/forward browser history buttons
    var prev_data = $('#geojson_state').val();
    var prev_value;
    var user_cleared = false;
    if (prev_data) {
        prev_value = JSON.parse(prev_data);
        if (prev_value) {
            $('#geojson').val(JSON.stringify(prev_value));
        } else {
            user_cleared = true;
        }
    } else {
        var geojson_val = $('#geojson').val();
        if (geojson_val) {
            prev_value = JSON.parse(geojson_val);
        } else {
            user_cleared = true;
        }
    }
    if (!user_cleared) {
        $('#adress').val(prev_value.properties.address);
    }
});
</script>

